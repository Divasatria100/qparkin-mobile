╔═══════════════════════════════════════════════════════════════════════════════╗
║                    QPARKIN OTP REGISTRATION FLOW DIAGRAM                      ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                           PHASE 1: REGISTRATION                             │
└─────────────────────────────────────────────────────────────────────────────┘

    [User]                    [Flutter App]              [Laravel Backend]
       │                            │                            │
       │  1. Fill Form              │                            │
       │  (Nama, HP, PIN)           │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │  2. Click "Sign Up"        │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │  3. POST /api/auth/register│
       │                            │  {nama, nomor_hp, pin}     │
       │                            ├───────────────────────────>│
       │                            │                            │
       │                            │                            │  4. Validate Input
       │                            │                            │  ✓ Check HP unique
       │                            │                            │
       │                            │                            │  5. Generate OTP
       │                            │                            │  (6 digit random)
       │                            │                            │
       │                            │                            │  6. Save to DB
       │                            │                            │  ┌─────────────────┐
       │                            │                            │  │ otp_verifications│
       │                            │                            │  ├─────────────────┤
       │                            │                            │  │ nomor_hp        │
       │                            │                            │  │ otp_code        │
       │                            │                            │  │ expires_at      │
       │                            │                            │  │ is_verified: 0  │
       │                            │                            │  └─────────────────┘
       │                            │                            │
       │                            │                            │  7. Cache Data
       │                            │                            │  register_data_{hp}
       │                            │                            │  (10 min expire)
       │                            │                            │
       │                            │                            │  8. Send Email
       │                            │                            │  ┌──────────────┐
       │                            │                            ├─>│   Mailtrap   │
       │                            │                            │  │              │
       │                            │                            │  │ To: {hp}@    │
       │                            │                            │  │ qparkin.test │
       │                            │                            │  │              │
       │                            │                            │  │ OTP: 123456  │
       │                            │                            │  └──────────────┘
       │                            │                            │
       │                            │  9. Response               │
       │                            │  {success: true,           │
       │                            │   nomor_hp: "081...",      │
       │                            │   debug_email: "..."}      │
       │                            │<───────────────────────────┤
       │                            │                            │
       │  10. Show OTP Dialog       │                            │
       │  ┌──────────────────────┐  │                            │
       │  │  Verifikasi OTP      │  │                            │
       │  │  ┌──┬──┬──┬──┬──┬──┐│  │                            │
       │  │  │  │  │  │  │  │  ││  │                            │
       │  │  └──┴──┴──┴──┴──┴──┘│  │                            │
       │  │  Timer: 05:00        │  │                            │
       │  │  [Verifikasi]        │  │                            │
       │  └──────────────────────┘  │                            │
       │<───────────────────────────┤                            │
       │                            │                            │

┌─────────────────────────────────────────────────────────────────────────────┐
│                         PHASE 2: OTP VERIFICATION                           │
└─────────────────────────────────────────────────────────────────────────────┘

       │                            │                            │
       │  11. Check Mailtrap        │                            │
       │  (Get OTP: 123456)         │                            │
       │                            │                            │
       │  12. Input OTP             │                            │
       │  in Dialog                 │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │  13. POST /api/auth/       │
       │                            │      verify-otp            │
       │                            │  {nomor_hp, otp_code}      │
       │                            ├───────────────────────────>│
       │                            │                            │
       │                            │                            │  14. Find OTP
       │                            │                            │  WHERE nomor_hp
       │                            │                            │  AND is_verified=0
       │                            │                            │
       │                            │                            │  15. Validate
       │                            │                            │  ✓ Not expired?
       │                            │                            │  ✓ Code match?
       │                            │                            │
       │                            │                            │  16. Get Cache
       │                            │                            │  register_data_{hp}
       │                            │                            │
       │                            │                            │  17. Create User
       │                            │                            │  ┌─────────────┐
       │                            │                            │  │    user     │
       │                            │                            │  ├─────────────┤
       │                            │                            │  │ name        │
       │                            │                            │  │ nomor_hp    │
       │                            │                            │  │ password    │
       │                            │                            │  │ role: cust  │
       │                            │                            │  │ status: aktif│
       │                            │                            │  └─────────────┘
       │                            │                            │
       │                            │                            │  18. Mark OTP
       │                            │                            │  is_verified = 1
       │                            │                            │
       │                            │                            │  19. Clear Cache
       │                            │                            │  forget(register_
       │                            │                            │  data_{hp})
       │                            │                            │
       │                            │  20. Response              │
       │                            │  {success: true,           │
       │                            │   message: "Verifikasi     │
       │                            │   berhasil!"}              │
       │                            │<───────────────────────────┤
       │                            │                            │
       │  21. Close Dialog          │                            │
       │  Show Success Message      │                            │
       │<───────────────────────────┤                            │
       │                            │                            │
       │  22. Navigate to Login     │                            │
       │<───────────────────────────┤                            │
       │                            │                            │

┌─────────────────────────────────────────────────────────────────────────────┐
│                         PHASE 3: LOGIN (OPTIONAL)                           │
└─────────────────────────────────────────────────────────────────────────────┘

       │                            │                            │
       │  23. Input HP & PIN        │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │  24. POST /api/auth/login  │
       │                            ├───────────────────────────>│
       │                            │                            │
       │                            │  25. Response + Token      │
       │                            │<───────────────────────────┤
       │                            │                            │
       │  26. Navigate to Home      │                            │
       │<───────────────────────────┤                            │
       │                            │                            │

╔═══════════════════════════════════════════════════════════════════════════════╗
║                              RESEND OTP FLOW                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    [User]                    [Flutter App]              [Laravel Backend]
       │                            │                            │
       │  Timer expired (00:00)     │                            │
       │                            │                            │
       │  Click "Kirim Ulang"       │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │  POST /api/auth/resend-otp │
       │                            │  {nomor_hp}                │
       │                            ├───────────────────────────>│
       │                            │                            │
       │                            │                            │  Get Cache Data
       │                            │                            │  register_data_{hp}
       │                            │                            │
       │                            │                            │  Generate New OTP
       │                            │                            │
       │                            │                            │  Delete Old OTP
       │                            │                            │
       │                            │                            │  Save New OTP
       │                            │                            │
       │                            │                            │  Send Email
       │                            │                            ├─>│ Mailtrap │
       │                            │                            │
       │                            │  Response                  │
       │                            │<───────────────────────────┤
       │                            │                            │
       │  Reset Timer to 05:00      │                            │
       │  Clear Input Fields        │                            │
       │<───────────────────────────┤                            │
       │                            │                            │

╔═══════════════════════════════════════════════════════════════════════════════╗
║                            SECURITY FEATURES                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│  ✓ OTP expires after 5 minutes                                              │
│  ✓ OTP can only be used once (is_verified flag)                            │
│  ✓ Old OTP deleted when generating new one                                 │
│  ✓ Registration data cached for 10 minutes (auto-expire)                   │
│  ✓ Email sent to dummy address (no real SMS cost)                          │
│  ✓ PIN hashed with bcrypt before storing                                   │
│  ✓ Unique constraint on nomor_hp in database                               │
└─────────────────────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════╗
║                              DATABASE SCHEMA                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│  TABLE: otp_verifications                                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│  id              BIGINT UNSIGNED (PK, AUTO_INCREMENT)                        │
│  nomor_hp        VARCHAR(20) (INDEXED)                                       │
│  otp_code        VARCHAR(6)                                                  │
│  expires_at      TIMESTAMP                                                   │
│  is_verified     BOOLEAN (DEFAULT: false)                                    │
│  created_at      TIMESTAMP                                                   │
│  updated_at      TIMESTAMP                                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│  CACHE: register_data_{nomor_hp}                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│  nama            STRING                                                       │
│  nomor_hp        STRING                                                       │
│  pin             STRING (plain, will be hashed on user creation)             │
│  TTL             10 minutes                                                   │
└──────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
                              END OF DIAGRAM
═══════════════════════════════════════════════════════════════════════════════
